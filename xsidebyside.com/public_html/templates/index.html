{% extends 'base.html' %}

{% block title %}Side by Side - Version Comparison{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="fa-solid fa-code-compare me-2"></i>Compare Versions
                </h3>
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger" role="alert">
                    {{ error }}
                </div>
                {% endif %}

                <!-- Product Selection -->
                <div class="mb-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="product-select" onchange="switchProduct()">
                                    {% for product in products %}
                                    <option value="{{ product.name }}" {% if product.name == selected_product %}selected{% endif %}>
                                        {{ product.display_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <label for="product-select">Product</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="version-form" action="{{ url_for('compare') }}" method="post" class="version-selector">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" id="product-input" name="product" value="{{ selected_product }}">
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="from-version" name="from_version">
                                    <option value="">Select version</option>
                                    {% for version in versions %}
                                    <option value="{{ version }}">{{ version }}</option>
                                    {% endfor %}
                                </select>
                                <label for="from-version">From Version</label>
                            </div>
                        </div>
                        
                        <div class="col-md-2 text-center">
                            <button type="button" id="swap-versions" class="btn btn-secondary" 
                                    data-bs-toggle="tooltip" title="Swap versions">
                                <i class="fa-solid fa-exchange-alt"></i>
                            </button>
                        </div>
                        
                        <div class="col-md-5">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="to-version" name="to_version">
                                    <option value="">Select version</option>
                                    {% for version in versions %}
                                    <option value="{{ version }}">{{ version }}</option>
                                    {% endfor %}
                                </select>
                                <label for="to-version">To Version</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connector Filtering -->
                    <div class="mt-4">
                        <div class="row">
                            <div class="col-12">
                                <h5 class="mb-3">
                                    <i class="fa-solid fa-filter me-2"></i>Filter by Connectors (Optional)
                                </h5>
                                <div class="connector-filter-grid">
                                    {% for connector in connectors %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors"
                                               value="{{ connector.name }}"
                                               id="connector_{{ connector.name|lower|replace(' ', '_')|replace('-', '_') }}">
                                        <label class="form-check-label" for="connector_{{ connector.name|lower|replace(' ', '_')|replace('-', '_') }}">
                                            {{ connector.name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="selectAllConnectors()">
                                        <i class="fa-solid fa-check-double me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllConnectors()">
                                        <i class="fa-solid fa-times me-1"></i>Clear All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fa-solid fa-search me-2"></i>Compare Versions
                        </button>
                    </div>
                </form>
                
                <div id="loading-spinner" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating comparison...</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h4 class="mb-0">
                    <i class="fa-solid fa-search me-2"></i>Search for Changes
                </h4>
            </div>
            <div class="card-body">
                <form id="search-form" class="search-form">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="input-group">
                                <input type="text" id="search-keyword" class="form-control"
                                       placeholder="Search for specific changes (min 3 characters)">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fa-solid fa-search"></i> Search
                                </button>
                            </div>
                            <small class="text-muted">Optionally filter by product, connector, and version range below</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="search-product">
                                    <option value="">All Products</option>
                                    {% for product in products %}
                                    <option value="{{ product.name }}" {% if product.name == selected_product %}selected{% endif %}>
                                        {{ product.display_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <label for="search-product">Product (Optional)</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="search-connector">
                                    <option value="">All Connectors</option>
                                    {% for connector in connectors %}
                                    <option value="{{ connector.name }}">{{ connector.name }}</option>
                                    {% endfor %}
                                </select>
                                <label for="search-connector">Connector (Optional)</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="search-from-version">
                                    <option value="">Any Version</option>
                                    {% for version in versions %}
                                    <option value="{{ version }}">{{ version }}</option>
                                    {% endfor %}
                                </select>
                                <label for="search-from-version">From Version (Optional)</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="search-to-version">
                                    <option value="">Any Version</option>
                                    {% for version in versions %}
                                    <option value="{{ version }}">{{ version }}</option>
                                    {% endfor %}
                                </select>
                                <label for="search-to-version">To Version (Optional)</label>
                            </div>
                        </div>
                    </div>
                </form>

                <div id="search-spinner" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Searching...</p>
                </div>

                <div id="search-results" class="search-results">
                    <!-- Search results will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function switchProduct() {
    const selectedProduct = document.getElementById('product-select').value;
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('product', selectedProduct);
    window.location.href = currentUrl.toString();
}

// Update hidden product input when product selection changes
document.getElementById('product-select').addEventListener('change', function() {
    document.getElementById('product-input').value = this.value;
});

// Connector filtering functions
function selectAllConnectors() {
    const checkboxes = document.querySelectorAll('input[name="connectors"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function clearAllConnectors() {
    const checkboxes = document.querySelectorAll('input[name="connectors"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}
</script>

<style>
.connector-filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.connector-filter-grid .form-check {
    margin-bottom: 0;
}

.connector-filter-grid .form-check-label {
    font-weight: 500;
    cursor: pointer;
}

.connector-filter-grid .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>
{% endblock %}
