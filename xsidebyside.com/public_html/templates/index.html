{% extends 'base.html' %}

{% block title %}{{ selected_product|title }} Version Comparison - Home{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="fa-solid fa-code-compare me-2"></i>Compare {{ selected_product|title }} Versions
                </h3>
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger" role="alert">
                    {{ error }}
                </div>
                {% endif %}
                
                {% if request.args.get('refresh_status') == 'success' %}
                <div class="alert alert-success" role="alert">
                    <i class="fa-solid fa-check-circle me-2"></i>Version data refreshed successfully!
                </div>
                {% elif request.args.get('refresh_status') == 'error' %}
                <div class="alert alert-danger" role="alert">
                    <i class="fa-solid fa-exclamation-circle me-2"></i>Error refreshing data: {{ request.args.get('error', 'Unknown error') }}
                </div>
                {% endif %}
                
                <!-- Product Selection -->
                <div class="mb-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="product-select" onchange="switchProduct()">
                                    {% for product in products %}
                                    <option value="{{ product.name }}" {% if product.name == selected_product %}selected{% endif %}>
                                        {{ product.display_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <label for="product-select">Product</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="version-form" action="{{ url_for('compare') }}" method="post" class="version-selector">
                    <input type="hidden" id="product-input" name="product" value="{{ selected_product }}">
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="from-version" name="from_version">
                                    <option value="">Select version</option>
                                    {% for version in versions %}
                                    <option value="{{ version }}">{{ version }}</option>
                                    {% endfor %}
                                </select>
                                <label for="from-version">From Version</label>
                            </div>
                        </div>
                        
                        <div class="col-md-2 text-center">
                            <button type="button" id="swap-versions" class="btn btn-secondary" 
                                    data-bs-toggle="tooltip" title="Swap versions">
                                <i class="fa-solid fa-exchange-alt"></i>
                            </button>
                        </div>
                        
                        <div class="col-md-5">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="to-version" name="to_version">
                                    <option value="">Select version</option>
                                    {% for version in versions %}
                                    <option value="{{ version }}">{{ version }}</option>
                                    {% endfor %}
                                </select>
                                <label for="to-version">To Version</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connector Filtering -->
                    <div class="mt-4">
                        <div class="row">
                            <div class="col-12">
                                <h5 class="mb-3">
                                    <i class="fa-solid fa-filter me-2"></i>Filter by Connectors (Optional)
                                </h5>
                                <div class="connector-filter-grid">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="Redshift" id="connector_redshift">
                                        <label class="form-check-label" for="connector_redshift">Redshift</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="Iceberg" id="connector_iceberg">
                                        <label class="form-check-label" for="connector_iceberg">Iceberg</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="Databricks" id="connector_databricks">
                                        <label class="form-check-label" for="connector_databricks">Databricks</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="Glue" id="connector_glue">
                                        <label class="form-check-label" for="connector_glue">Glue</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="PostgreSQL" id="connector_postgresql">
                                        <label class="form-check-label" for="connector_postgresql">PostgreSQL</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="Delta Lake" id="connector_deltalake">
                                        <label class="form-check-label" for="connector_deltalake">Delta Lake</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="Hive" id="connector_hive">
                                        <label class="form-check-label" for="connector_hive">Hive</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="BigQuery" id="connector_bigquery">
                                        <label class="form-check-label" for="connector_bigquery">BigQuery</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="Oracle" id="connector_oracle">
                                        <label class="form-check-label" for="connector_oracle">Oracle</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="OpenSearch" id="connector_opensearch">
                                        <label class="form-check-label" for="connector_opensearch">OpenSearch</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="MySQL" id="connector_mysql">
                                        <label class="form-check-label" for="connector_mysql">MySQL</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="SQL Server" id="connector_sqlserver">
                                        <label class="form-check-label" for="connector_sqlserver">SQL Server</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="MongoDB" id="connector_mongodb">
                                        <label class="form-check-label" for="connector_mongodb">MongoDB</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="connectors" value="Elasticsearch" id="connector_elasticsearch">
                                        <label class="form-check-label" for="connector_elasticsearch">Elasticsearch</label>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="selectAllConnectors()">
                                        <i class="fa-solid fa-check-double me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllConnectors()">
                                        <i class="fa-solid fa-times me-1"></i>Clear All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="fa-solid fa-search me-2"></i>Compare Versions
                        </button>
                        <a href="{{ url_for('refresh_data', product=selected_product) }}" class="btn btn-outline-secondary btn-lg">
                            <i class="fa-solid fa-refresh me-2"></i>Refresh {{ selected_product|title }} Data
                        </a>
                    </div>
                </form>
                
                <div id="loading-spinner" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating comparison...</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h4 class="mb-0">
                    <i class="fa-solid fa-search me-2"></i>Search for Changes
                </h4>
            </div>
            <div class="card-body">
                <form id="search-form" class="search-form">
                    <div class="input-group mb-3">
                        <input type="text" id="search-keyword" class="form-control" 
                               placeholder="Search for specific changes (min 3 characters)">
                        <button class="btn btn-primary" type="submit">
                            <i class="fa-solid fa-search"></i> Search
                        </button>
                    </div>
                </form>
                
                <div id="search-spinner" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Searching...</p>
                </div>
                
                <div id="search-results" class="search-results">
                    <!-- Search results will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function switchProduct() {
    const selectedProduct = document.getElementById('product-select').value;
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('product', selectedProduct);
    window.location.href = currentUrl.toString();
}

// Update hidden product input when product selection changes
document.getElementById('product-select').addEventListener('change', function() {
    document.getElementById('product-input').value = this.value;
});

// Connector filtering functions
function selectAllConnectors() {
    const checkboxes = document.querySelectorAll('input[name="connectors"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function clearAllConnectors() {
    const checkboxes = document.querySelectorAll('input[name="connectors"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}
</script>

<style>
.connector-filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.connector-filter-grid .form-check {
    margin-bottom: 0;
}

.connector-filter-grid .form-check-label {
    font-weight: 500;
    cursor: pointer;
}

.connector-filter-grid .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>
{% endblock %}
